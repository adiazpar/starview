# Run this in Django shell on production:
# python manage.py shell
# Then paste the code below

import json
from pathlib import Path
from starview_app.models import Location

# Load validated_observatories.json with full precision coordinates
json_path = Path('seed_data/validated_observatories.json')
with open(json_path) as f:
    data = json.load(f)

# Build lookup dict by truncated coordinates (3 decimal places) for matching
# Key: (truncated_lat, truncated_lon) -> observatory data
coord_lookup = {}
for obs in data['observatories']:
    key = (round(obs['latitude'], 3), round(obs['longitude'], 3))
    if key not in coord_lookup:
        coord_lookup[key] = []
    coord_lookup[key].append(obs)

# Get all observatory locations from database
observatory_locations = Location.objects.filter(location_type='observatory')
print(f"Found {observatory_locations.count()} observatories in database")

updated = 0
not_found = []
multiple_matches = []

for loc in observatory_locations:
    # Create truncated key from database coords
    key = (round(float(loc.latitude), 3), round(float(loc.longitude), 3))

    matches = coord_lookup.get(key, [])

    if len(matches) == 0:
        not_found.append((loc.id, loc.name, loc.latitude, loc.longitude))
        continue

    if len(matches) == 1:
        obs = matches[0]
    else:
        # Multiple matches - try to match by name
        name_matches = [m for m in matches if m['name'].lower() == loc.name.lower()]
        if len(name_matches) == 1:
            obs = name_matches[0]
        else:
            # Try fuzzy name match
            obs = None
            for m in matches:
                if loc.name.lower() in m['name'].lower() or m['name'].lower() in loc.name.lower():
                    obs = m
                    break
            if not obs:
                multiple_matches.append((loc.id, loc.name, [m['name'] for m in matches]))
                continue

    # Check if coordinates actually changed
    old_lat, old_lon = float(loc.latitude), float(loc.longitude)
    new_lat, new_lon = obs['latitude'], obs['longitude']

    if old_lat != new_lat or old_lon != new_lon:
        loc.latitude = new_lat
        loc.longitude = new_lon
        loc.save(update_fields=['latitude', 'longitude'])
        updated += 1
        print(f"Updated {loc.name}: ({old_lat}, {old_lon}) -> ({new_lat}, {new_lon})")

print(f"\n=== SUMMARY ===")
print(f"Updated: {updated}")
print(f"Not found: {len(not_found)}")
print(f"Multiple matches (skipped): {len(multiple_matches)}")

if not_found:
    print(f"\nNot found in JSON (may have different coords):")
    for id, name, lat, lon in not_found[:10]:
        print(f"  ID {id}: {name} ({lat}, {lon})")
    if len(not_found) > 10:
        print(f"  ... and {len(not_found) - 10} more")

if multiple_matches:
    print(f"\nMultiple matches (manual review needed):")
    for id, name, candidates in multiple_matches:
        print(f"  ID {id}: {name} -> {candidates}")
